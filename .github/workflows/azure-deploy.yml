name: Deploy to Azure

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

env:
  DOTNET_VERSION: '10.0.x'
  AZURE_WEBAPP_PACKAGE_PATH: './publish'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal
    
    - name: Publish
      run: dotnet publish src/FuknWeather.Api/FuknWeather.Api.csproj -c Release -o ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

  deploy-infrastructure:
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
    
    outputs:
      appServiceName: ${{ steps.deploy-infra.outputs.appServiceName }}
      appServiceUrl: ${{ steps.deploy-infra.outputs.appServiceUrl }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Determine environment
      id: env
      run: |
        if [ "${{ github.event.inputs.environment }}" != "" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "environment=prod" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
        fi
    
    - name: Set resource group name
      id: rg
      run: |
        ENV=${{ steps.env.outputs.environment }}
        echo "resourceGroup=rg-fukn-weather-${ENV}" >> $GITHUB_OUTPUT
    
    - name: Create resource group
      run: |
        az group create \
          --name ${{ steps.rg.outputs.resourceGroup }} \
          --location eastus
    
    - name: Deploy infrastructure
      id: deploy-infra
      run: |
        DEPLOYMENT_OUTPUT=$(az deployment group create \
          --resource-group ${{ steps.rg.outputs.resourceGroup }} \
          --template-file infrastructure/main.bicep \
          --parameters infrastructure/parameters.json \
          --parameters environment=${{ steps.env.outputs.environment }} \
          --parameters weatherApiKey="${{ secrets.WEATHER_API_KEY }}" \
          --query properties.outputs \
          --output json)
        
        echo "appServiceName=$(echo $DEPLOYMENT_OUTPUT | jq -r '.appServiceName.value')" >> $GITHUB_OUTPUT
        echo "appServiceUrl=$(echo $DEPLOYMENT_OUTPUT | jq -r '.appServiceUrl.value')" >> $GITHUB_OUTPUT

  deploy-application:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4.1.3
      with:
        name: webapp
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Determine environment
      id: env
      run: |
        if [ "${{ github.event.inputs.environment }}" != "" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "environment=prod" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
        fi
    
    - name: Set resource group name
      id: rg
      run: |
        ENV=${{ steps.env.outputs.environment }}
        echo "resourceGroup=rg-fukn-weather-${ENV}" >> $GITHUB_OUTPUT
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ needs.deploy-infrastructure.outputs.appServiceName }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
    
    - name: Test deployment
      run: |
        sleep 10
        curl -f "${{ needs.deploy-infrastructure.outputs.appServiceUrl }}/api/weather/10001" || exit 1
    
    - name: Deployment summary
      run: |
        echo "### Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group:** ${{ steps.rg.outputs.resourceGroup }}" >> $GITHUB_STEP_SUMMARY
        echo "- **App Service:** ${{ needs.deploy-infrastructure.outputs.appServiceName }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL:** ${{ needs.deploy-infrastructure.outputs.appServiceUrl }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test your deployment :white_check_mark:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "curl ${{ needs.deploy-infrastructure.outputs.appServiceUrl }}/api/weather/10001" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  post-deployment:
    needs: [deploy-infrastructure, deploy-application]
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
    
    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Determine environment
      id: env
      run: |
        if [ "${{ github.event.inputs.environment }}" != "" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "environment=prod" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
        fi
    
    - name: Set resource group name
      id: rg
      run: |
        ENV=${{ steps.env.outputs.environment }}
        echo "resourceGroup=rg-fukn-weather-${ENV}" >> $GITHUB_OUTPUT
    
    - name: Run health check
      run: |
        APP_URL="${{ needs.deploy-infrastructure.outputs.appServiceUrl }}"
        echo "Running health check on $APP_URL"
        
        # Wait for app to be ready
        for i in {1..6}; do
          if curl -f -s "$APP_URL/api/weather/10001" > /dev/null; then
            echo "✅ Health check passed"
            exit 0
          fi
          echo "Waiting for app to be ready (attempt $i/6)..."
          sleep 10
        done
        
        echo "❌ Health check failed"
        exit 1
    
    - name: Configure monitoring alerts (optional)
      continue-on-error: true
      run: |
        # This is optional - configure alerts if needed
        echo "Monitoring alerts can be configured here"
